<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Appointment Manager</title>
  <meta name="robots" content="noindex, nofollow" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      padding: 20px;
      margin: 0;
      background: #f1f5f9; /* New: Slightly darker grey background */
      color: #334155;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
    }

    
    .container {
      background: #fff;
      border: 1px solid #e0e0e0;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 900px; /* Wider container for table */
      box-sizing: border-box;
    }

    .back-link {
      display: inline-block;
      margin-bottom: 15px;
      color: #0D9488;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    h2 {
      margin-bottom: 25px;
      color: #0D9488;
      text-align: center;
      font-size: 1.8rem;
      margin-top: 0;
      font-weight: 700;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      margin-top: 12px;
    }

    input[type="text"],
    input[type="date"],
    input[type="tel"],
    input[type="time"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 12px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
      box-sizing: border-box;
      color: #334155;
      background-color: #fff;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    input[type="tel"]:focus,
    input[type="time"]:focus,
    input[type="number"]:focus,
    textarea:focus {
      outline: none;
      border-color: #0D9488;
      box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.2);
    }

    textarea {
      resize: none;
      height: 80px;
    }

    button {
      width: 100%;
      padding: 12px 0;
      background-color: #0D9488;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      margin-top: 15px;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }

    button:hover {
      background-color: #0F766E;
      transform: translateY(-2px);
    }

    .error {
      color: #991B1B;
      background-color: #FEE2E2;
      border: 1px solid #FCA5A5;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
      font-size: 0.9rem;
      display: none;
    }

    /* New styles for service input fields to be on the same row */
    .service-fields-row {
      display: flex;
      gap: 15px; /* Space between service and cost fields */
      flex-wrap: wrap; /* Allow wrapping on smaller screens */
      margin-top: 5px; /* Space below the remove button */
    }
    .service-field {
      flex: 1; /* Each field takes equal space */
      min-width: 120px; /* Minimum width to prevent squishing */
    }
    .service-field label {
      margin-top: 0; /* Override general label margin */
      margin-bottom: 5px; /* Small space between label and input */
    }
    /* End new styles */

    /* Service Item Styles (similar to bill.html) */
    .service-item {
      margin-bottom: 15px;
      padding: 15px;
      border: 1px solid #E2E8F0;
      border-radius: 8px;
      background-color: #F8FAFC;
      position: relative;
    }

    #addServiceBtn {
      background-color: #14B8A6; /* A secondary teal color */
      margin-top: 10px;
      margin-bottom: 20px; /* Space below add service button */
      /* Make it smaller to differentiate from the main action button */
      width: auto;
      padding: 8px 16px;
      font-size: 0.9rem;
      font-weight: 600;
      align-self: flex-start; /* Align to the left */
    }
    #addServiceBtn:hover {
      background-color: #0D9488;
    }

    .remove-service-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #FEE2E2;
      border: 1px solid #FCA5A5;
      color: #DC2626;
      font-size: 0.8rem;
      font-weight: bold;
      cursor: pointer;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      transition: all 0.2s ease;
    }
    .remove-service-btn:hover {
        background: #FECACA;
        color: #B91C1C;
    }

    /* Adjust button styling for update/add */
    #addBtn, #updateBtn { /* Apply to both states of the button */
        margin-top: 15px; /* Ensure consistent spacing */
    }

    .form-container-collapsible {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 25px;
        margin-top: 20px;
        background-color: #fff; /* White background for form */
        display: none; /* Hidden by default */
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    .form-grid div label {
        margin-top: 0;
    }
    .form-grid div input {
        margin-bottom: 0;
    }
    @media (max-width: 600px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
        body {
            padding: 10px;
        }
        .container, #bill-preview-container {
            padding: 15px;
        }
        h2 {
            font-size: 1.5rem;
        }
        .main-actions-toolbar {
            flex-direction: column;
        }
        .main-actions-toolbar > button {
            width: 100%;
        }
    }

    .main-actions-toolbar {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        flex-wrap: wrap;
        justify-content: space-between; /* This will push items to opposite ends */
    }
    .main-actions-toolbar > button {
        width: auto;
        margin-top: 0;
        padding: 10px 15px;
        font-size: 0.9rem;
    }

    /* New styles for filter */
    .filter-container {
        display: flex;
        align-items: center;
        gap: 8px;
        /* margin-left: auto; - No longer needed with justify-content */
    }
    .filter-container label {
        margin: 0; /* Reset margin from general label style */
        font-size: 0.9rem;
        font-weight: 600;
    }
    .filter-container input[type="date"] {
        padding: 8px 10px; /* Smaller padding for toolbar */
        margin: 0; /* Reset margin */
        width: auto;
        font-size: 0.9rem;
    }

    /* --- New Button Styles --- */
    #showAddFormBtn {
        background-color: #0D9488;
    }
    #showAddFormBtn:hover {
        background-color: #0F766E;
    }
    #showAddFormBtn.close-form {
        background-color: transparent;
        color: #DC2626; /* Red text */
        border: 2px solid #DC2626;
    }
    #showAddFormBtn.close-form:hover {
        background-color: #FEE2E2; /* Light red background on hover */
        color: #B91C1C;
    }

    /* General Action Button in Cards */
    .action-btn {
      font-size: 0.8rem;
      padding: 6px 12px;
      margin: 0;
      width: auto;
      display: inline-block;
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
      text-align: center;
    }
    .action-btn:hover {
        opacity: 0.85;
        transform: translateY(-1px);
    } 

    /* --- New Card Layout Styles --- */
    .appointment-list {
      margin-top: 30px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .appointment-card {
      background-color: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      padding: 20px;
      transition: box-shadow 0.2s ease;
    }
    .appointment-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 15px;
      border-bottom: 1px solid #f1f5f9;
      padding-bottom: 15px;
      margin-bottom: 15px;
    }
    .patient-name {
      font-weight: 700;
      font-size: 1.1rem;
      color: #1e293b;
    }
    .contact-info {
      font-size: 0.9rem;
      color: #475569;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .card-body {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    .datetime-info, .status-details {
      font-size: 0.9rem;
    }
    .datetime-info strong, .status-details strong {
      display: block;
      color: #64748b;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .whatsapp-icon-svg {
        display: inline-block;
        width: 1.1rem;
        height: 1.1rem;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2325D366' viewBox='0 0 16 16'%3e%3cpath d='M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.068-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-size: contain;
    }
    .phone-icon-svg {
        display: inline-block;
        width: 1.1rem;
        height: 1.1rem;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%233B82F6' viewBox='0 0 24 24'%3e%3cpath d='M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-size: contain;
    }

    .icon-link {
        text-decoration: none;
        display: inline-flex;
        align-items: center;
    }

    /* Hide icons on desktop (screens wider than 768px) */
    @media (min-width: 768px) {
      .mobile-only-icon {
        display: none;
      }
    }
    
    .card-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px; 
      justify-content: flex-end; /* Align dropdown to the right */
    }
    .card-actions .action-btn {
      flex-grow: 1;
      min-width: 80px;
    }

    /* --- New Dropdown Styles --- */
    .actions-dropdown {
      position: relative;
      display: inline-block;
    }

    .actions-main-btn {
      background-color: #64748B; /* Slate */
      min-width: 120px;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #ffffff;
      min-width: 160px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      z-index: 1;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
      right: 0; /* Align to the right of the button */
      bottom: 100%; /* Position above the button */
      margin-bottom: 5px;
    }

    .dropdown-content a {
      color: #334155;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      font-size: 0.9rem;
      border-bottom: 1px solid #f1f5f9;
    }
    .dropdown-content a:last-child {
      border-bottom: none;
    }

    .dropdown-content a:hover {
      background-color: #f8fafc;
    }

    .empty-list-message {
        text-align: center;
        padding: 40px 20px;
        color: #64748b;
        background-color: #fff;
        border: 1px dashed #cbd5e1;
        border-radius: 8px;
        margin-top: 30px;
    }

    /* Loader styles */
    #loader-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: none; /* Hidden by default */
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .loader {
      border: 8px solid #f3f3f3; /* Light grey */
      border-top: 8px solid #0D9488; /* Teal */
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  </style>
</head>
<body>
  <div id="loader-overlay">
    <div class="loader"></div>
  </div>
  <div class="container">
    <a href="admin.html" class="back-link">← Back to Admin Panel</a>
    <h2>Appointment Manager</h2>
    <div id="error" class="error"></div>

    <div id="add-form-container" class="form-container-collapsible">
        <div class="form-grid">
            <div>
                <label for="name">Patient Name:</label>
                <input type="text" id="name" placeholder="Enter patient's name">
            </div>
            <div>
                <label for="phone">Mobile Number:</label>
                <input type="tel" id="phone" placeholder="e.g. 9444261111">
            </div>
            <div>
                <label for="date">Date:</label>
                <input type="date" id="date">
            </div>
            <div>
                <label for="time">Time:</label>
                <input type="time" id="time">
            </div>
        </div>
        <h3>Services (Optional)</h3>
        <div id="services-container">
            <!-- Service items will be added here dynamically -->
        </div>
        <button id="addServiceBtn" type="button">➕ Add Service</button>
        <button id="addBtn">Save Appointment</button> <!-- This will toggle to Update List -->
    </div>

    <div class="main-actions-toolbar">
        <button id="showAddFormBtn">➕ Add New Appointment</button>
        <!-- The addBtn is moved here and its visibility will be managed by JS -->
        <button id="addBtn" style="display: none;">Add Appointment</button>

        <div class="filter-container">
            <label for="filterDate">Filter by Date:</label>
            <input type="date" id="filterDate">
        </div>
    </div>
    <div id="appointment-list-container" class="appointment-list">
        <!-- Cards will be added here by JavaScript -->
        <div id="appointmentsList"></div> <!-- This was misplaced and is now correctly here -->
    </div> 
  </div>

  <!-- Hidden bill template for PDF generation -->
  <div id="bill" style="display:none; padding: 40px; width: 794px; font-family: 'Roboto', sans-serif; color: #333; box-sizing: border-box; background: #fff; flex-direction: column; min-height: 1123px; margin: 20px auto 0 auto;">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #000; padding-bottom: 15px;">
      <div style="display: flex; align-items: center;">
        <img src="IMG-20250712-WA0001.jpg" alt="Clinic Logo" style="width: 70px; height: 70px; margin-right: 15px; border-radius: 8px; filter: grayscale(100%);">
        <div>
          <h1 style="color: #000; margin: 0; font-size: 22px; font-weight: 700; white-space: nowrap;">Dr Mani's Ortho Speciality & General Clinic</h1>
          <p style="margin: 4px 0 0 0; font-size: 12px; font-style: italic; color: #555;">Compassionate care for a pain-free life.</p>
          <p style="margin: 5px 0 0 0; font-size: 12px;">68, Radha Nagar Main Road, opposite J2 Mahal, Chromepet, Chennai</p>
          <p style="margin: 5px 0 0 0; font-size: 12px;"><b>Phone:</b> +91-9444261111</p>
          <p style="margin: 5px 0 0 0; font-size: 12px;"><b>Website:</b> https://drmaniortho.in/</p>
        </div>
      </div>
      <div style="text-align: right;">
        <p style="margin: 5px 0 0 0; font-size: 12px;"><b>Dr. Mani Arumugam,</b> M.B.B.S., M.S. (Ortho)</p>
        <p style="margin: 5px 0 0 0; font-size: 12px;"><b>Registration No:</b> 98278</p>
      </div>
    </div>
  
    <!-- Bill Details -->
    <div style="display: flex; justify-content: space-between; margin-top: 25px;">
      <div>
        <h3 style="margin: 0; font-size: 14px; color: #555; font-weight: bold;">Bill To: <span id="billPatient" style="color: #333; font-weight: normal;"></span></h3>
      </div>
      <div style="text-align: right;">
        <!-- <p style="margin: 0; font-size: 14px;"><b style="color: #555;">Bill Number:</b> <span id="billNumber"></span></p> -->
        <p style="margin: 5px 0 0 0; font-size: 14px;"><b style="color: #555;">Bill Date:</b> <span id="billDateText"></span></p>
      </div>
    </div>
  
    <!-- Services Table -->
    <table style="width: 100%; border-collapse: collapse; margin-top: 30px; font-size: 14px;">
      <thead style="background-color: #f3f4f6;">
        <tr>
          <th style="border-bottom: 2px solid #ddd; padding: 12px; text-align: left; color: #000; width: 50px;">S.NO</th>
          <th style="border-bottom: 2px solid #ddd; padding: 12px; text-align: left; color: #000;">Service Description</th>
          <th style="border-bottom: 2px solid #ddd; padding: 12px; text-align: right; color: #000; width: 120px;">Cost (₹)</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows will be added dynamically -->
      </tbody>
      <tfoot>
        <tr>
          <td colspan="2" style="border-top: 2px solid #ddd; padding: 12px; text-align: right; font-weight: bold;">Total</td>
          <td id="billTotal" style="border-top: 2px solid #ddd; padding: 12px; text-align: right; font-weight: bold; color: #000; font-size: 16px;"></td>
        </tr>
      </tfoot>
    </table>
  
    <!-- Footer -->
    <div style="margin-top: 40px; border-top: 1px solid #eee; padding-top: 15px;">
        <p style="text-align: center; font-size: 12px; color: #777; margin-bottom: 20px;">Thank you for choosing our clinic!</p>
        <div style="display: flex; justify-content: space-between; align-items: flex-end;">
            <div style="text-align: left;">
              
            </div>
            <div style="text-align: center;">
                <img src="signature.png" alt="Signature" style="width: 140px; height: 60px; display: block; margin-bottom: -5px;">
                <p style="font-size: 12px; color: #333; border-top: 1px solid #999; padding-top: 5px; margin: 0;">Authorized Signature</p>
            </div>
        </div>
    </div>
  </div>
  <script>
    // Element selectors
    const nameInput = document.getElementById('name');
    const phoneInput = document.getElementById('phone');
    const dateInput = document.getElementById('date');
    const timeInput = document.getElementById('time');
    const addBtn = document.getElementById('addBtn');
    const showAddFormBtn = document.getElementById('showAddFormBtn');
    const addServiceBtn = document.getElementById('addServiceBtn');
    const addFormContainer = document.getElementById('add-form-container');
    const appointmentsList = document.getElementById('appointmentsList');
    const filterDateInput = document.getElementById('filterDate');
    const errorDiv = document.getElementById("error");
    const API_BASE_URL = 'https://dr-appointment-t10x.onrender.com';
    const loaderOverlay = document.getElementById('loader-overlay');
    //const API_BASE_URL = 'http://localhost:3000';

    function showLoader() {
        if (loaderOverlay) loaderOverlay.style.display = 'flex';
    }

    function hideLoader() {
        if (loaderOverlay) loaderOverlay.style.display = 'none';
    }

    // State variables
    let editingAppointmentId = null;
    let serviceCounter = 0;

    // Helper function to get today's date in YYYY-MM-DD format
    function getTodayDateString() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }

    // Helper function to get current time in HH:MM format
    function getCurrentTimeString() {
        const now = new Date();
        const hh = String(now.getHours()).padStart(2, '0');
        const mm = String(now.getMinutes()).padStart(2, '0');
        return `${hh}:${mm}`;
    }

    // Set today's date in the date input field on page load
    window.onload = async function() {
      // Check for a URL parameter to auto-generate and download a bill.
      // Example: appointment-confirm.html?bill_phone=918015241869
      const urlParams = new URLSearchParams(window.location.search);
      const viewBillPhone = urlParams.get('view_bill_phone');
      const billPhone = urlParams.get('bill_phone');
      const billDate = urlParams.get('date'); // Read the date from URL
      const todayDateString = getTodayDateString();
      const currentTimeString = getCurrentTimeString();

      // Security Check: If not downloading a bill, user must be logged in.
      if (!billPhone && !viewBillPhone && localStorage.getItem('isAdminLoggedIn') !== 'true') {
          // Redirect to login page if not logged in and not accessing a bill via URL
          window.location.href = 'admin.html';
          return; // Stop further execution
      }

      // Set min time for the form's time input if the selected date is today
      if (dateInput.value === todayDateString) {
          timeInput.min = currentTimeString;
      } else {
          timeInput.min = '00:00'; // No time restriction for future dates
      }

      if (billPhone || viewBillPhone) {
          showLoader(); // Loader shown
          const container = document.querySelector('.container');
          // Replace page content with a status message
          container.innerHTML = '<h2>Generating Bill...</h2><div id="error" class="error"></div>';
          const autoBillErrorDiv = container.querySelector('#error');

          try {
              // Use the production API base URL for the shareable link to work for patients
              if (!billDate) {
                  throw new Error("Date parameter is missing in the URL.");
              }
              const response = await fetch(`${API_BASE_URL}/api/bill-details/${billPhone || viewBillPhone}?date=${billDate}`);

              if (!response.ok) {
                  let errorMsg = `HTTP error! status: ${response.status}`;
                  try {
                      const errorData = await response.json();
                      if (errorData.message) errorMsg = errorData.message;
                  } catch (e) { /* Ignore if response is not JSON */ }
                  throw new Error(errorMsg);
              }
              const billDetails = await response.json();

              if (billPhone) {
                await populateAndSavePdf(billDetails);
                container.innerHTML = '<h2>Bill downloaded successfully. You can close this window.</h2>';
              } else if (viewBillPhone) {
                document.title = `Bill for ${billDetails.patientName}`;
                populateBillTemplate(billDetails);
                container.style.display = 'none'; // Hide the main app container
                const billDiv = document.getElementById('bill');
                billDiv.style.display = 'flex'; // Show the bill
              }
          } catch (error) {
              console.error('Error auto-generating bill:', error);
              container.querySelector('h2').textContent = 'Error Generating Bill';
              autoBillErrorDiv.textContent = `Failed to auto-generate bill: ${error.message}`;
              autoBillErrorDiv.style.display = 'block';
          } finally {
              hideLoader(); // Loader hidden
          }
          return; // Stop further page initialization
      }

      // --- Default page load behavior ---
      dateInput.value = todayDateString;
      dateInput.min = todayDateString;

      // New logic to retain filter date
      const storedFilterDate = sessionStorage.getItem('filterDate');
      const initialFilterDate = storedFilterDate || todayDateString;
      filterDateInput.value = initialFilterDate;
      if (!storedFilterDate) {
          sessionStorage.setItem('filterDate', todayDateString);
      }

      // Set min time for the form's time input if the selected date is today
      if (dateInput.value === todayDateString) {
          timeInput.min = currentTimeString;
      } else {
          timeInput.min = '00:00'; // No time restriction for future dates
      }
      dateInput.addEventListener('change', () => {
          const selectedDate = dateInput.value;
          const todayDate = getTodayDateString();
          const currentTime = getCurrentTimeString();
          timeInput.min = (selectedDate === todayDate) ? currentTime : '00:00';
          if (selectedDate === todayDate && timeInput.value && timeInput.value < currentTime) {
              timeInput.value = currentTime; // Reset time if it's in the past
          }
      });

      showLoader();
      // Load appointments for the initial filter date
      await loadAppointmentsByDate(initialFilterDate).finally(() => {
          hideLoader();
      });

      // Global click listener to close dropdowns
      window.addEventListener('click', function(event) {
          // Find all open dropdowns
          const openDropdowns = document.querySelectorAll('.dropdown-content');
          let clickedInsideDropdown = false;

          // Check if the click was on a main actions button
          if (event.target.matches('.actions-main-btn')) {
              clickedInsideDropdown = true;
          } else {
              // Check if the click was inside any dropdown content
              openDropdowns.forEach(dropdown => {
                  if (dropdown.contains(event.target)) {
                      clickedInsideDropdown = true;
                  }
              });
          }

          // If the click was outside, close all dropdowns
          if (!clickedInsideDropdown) {
              openDropdowns.forEach(dropdown => {
                  dropdown.style.display = 'none';
              });
          }
      });
      resetForm(); // Initialize form state
    };

    showAddFormBtn.addEventListener('click', () => {
        const isVisible = addFormContainer.style.display === 'block';
        if (isVisible) {
            // Form is visible, so we are closing it
            addFormContainer.style.display = 'none';
            showAddFormBtn.textContent = '➕ Add New Appointment';
            showAddFormBtn.classList.remove('close-form');
            addBtn.style.display = 'none'; // Hide addBtn when form is closed
            resetForm(); // Reset form when closing
        } else {
            // Form is hidden, so we are opening it
            resetForm(); // Reset form for a new entry
            addFormContainer.style.display = 'block';
            showAddFormBtn.textContent = '➖ Close Appointment Form';
            showAddFormBtn.classList.add('close-form');
            addBtn.style.display = 'block'; // Show addBtn when form is opened
        }
    });

    filterDateInput.addEventListener('change', async () => {
        const filterDate = filterDateInput.value;
        sessionStorage.setItem('filterDate', filterDate); // Store the new date
        showLoader();
        await loadAppointmentsByDate(filterDate).finally(() => {
            hideLoader();
        });
    });

    async function loadAppointmentsByDate(date) {
        try {
            if (!date) {
                renderTable([]); // Render an empty table if no date is provided
                return;
            }
            const response = await fetch(`${API_BASE_URL}/api/appointments/by-date?date=${date}`, { cache: 'no-cache' });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
            const appointments = await response.json();
            // Sort the fetched list by time (newest first)
            appointments.sort((a, b) => new Date(`${b.date}T${b.time}`) - new Date(`${a.date}T${a.time}`));
            renderTable(appointments);
        } catch (error) {
            console.error('Failed to load appointments:', error);
            errorDiv.textContent = 'Could not load appointments from the server. Make sure the server is running.';
            errorDiv.style.display = 'block';
            renderTable([]); // Clear the table on error
        }
    }

    // Function to add a service input field
    function addService(description = '', cost = 0) {
        serviceCounter++;
        const servicesContainer = document.getElementById('services-container');
        const serviceItem = document.createElement('div');
        serviceItem.classList.add('service-item');
        // Modified HTML structure to place service and cost inputs on the same row
        serviceItem.innerHTML = `
          <button type="button" class="remove-service-btn" title="Remove Service" onclick="this.parentElement.remove()">×</button>
          <div class="service-fields-row">
            <div class="service-field">
              <label for="service${serviceCounter}">Service:</label>
              <input type="text" id="service${serviceCounter}" class="service-desc" placeholder="Service description" value="${description}">
            </div>
            <div class="service-field">
              <label for="cost${serviceCounter}">Cost (₹):</label>
              <input type="number" id="cost${serviceCounter}" class="service-cost" min="0" value="${cost}">
            </div>
          </div>
        `;

        // Make the first "Consultation Fee" non-removable, both for new and edited appointments.
        if (servicesContainer.children.length === 0 && description === 'Consultation Fee') {
            const removeBtn = serviceItem.querySelector('.remove-service-btn');
            if (removeBtn) removeBtn.style.display = 'none';
        }

        servicesContainer.appendChild(serviceItem);
    }

    // Event listener for the "Add Service" button
    addServiceBtn.addEventListener('click', () => {
        const serviceItems = document.querySelectorAll('.service-item');
        if (serviceItems.length > 0) {
            const lastServiceItem = serviceItems[serviceItems.length - 1];
            const lastServiceDescInput = lastServiceItem.querySelector('.service-desc');
            const lastServiceDesc = lastServiceDescInput.value.trim();
            if (!lastServiceDesc) {
                errorDiv.textContent = 'Please fill in the current service description before adding a new one.';
                errorDiv.style.display = 'block';
                lastServiceDescInput.focus();
                return;
            }
        }
        errorDiv.style.display = 'none'; // Hide error if validation passes
        addService();
    });

    // Function to reset the form to "Add New Appointment" state
    function resetForm() {
        editingAppointmentId = null;
        nameInput.value = '';
        phoneInput.value = '';
        const todayDateString = getTodayDateString();
        const currentTimeString = getCurrentTimeString();

        dateInput.value = todayDateString;
        dateInput.min = todayDateString; // Ensure min date is set on reset
        timeInput.value = '';
        if (dateInput.value === todayDateString) {
            timeInput.min = currentTimeString;
        } else {
            timeInput.min = '00:00';
        }
        document.getElementById('services-container').innerHTML = ''; // Clear all service fields
                addBtn.textContent = 'Add Appointment';
        addBtn.classList.remove('update-mode'); 
        errorDiv.style.display = 'none';
        addBtn.style.display = 'block'; // Ensure addBtn is visible when form is reset (and open)
        // Make inputs editable (in case they were read-only from an edit)
        [nameInput, phoneInput, dateInput, timeInput].forEach(input => input.readOnly = false);
    }

    function renderTable(appointments) {
        appointmentsList.innerHTML = ''; // Clear existing items

        if (appointments.length === 0) {
            appointmentsList.innerHTML = '<p class="empty-list-message">No appointments scheduled.</p>';
        } else {
            appointments.forEach(appt => {
                const card = document.createElement('div');
                card.className = 'appointment-card';
                card.dataset.id = appt.id;
                // Store data in dataset for easy and robust access
                card.dataset.name = appt.name;
                card.dataset.phone = appt.phone;
                card.dataset.date = appt.date;
                card.dataset.time = appt.time;
                card.dataset.services = JSON.stringify(appt.services || []);
                card.dataset.billupdateflag = appt.billupdateflag;
 
                const confirmationStatus = appt.confirmationSent 
                    ? `<span class="status-sent status-confirmed">Sent</span>`
                    : `<span class="status-pending">Pending</span>`;

                const reviewStatus = appt.reviewSent
                    ? `<span class="status-sent status-review-sent">Sent</span>`
                    : `<span class="status-pending">Pending</span>`;

                const billStatus = appt.billupdateflag
                    ? `<span style="color: #16A34A; font-weight: 600;">Generated</span>`
                    : `<span style="color: #94a3b8;">Pending</span>`;

                const [year, month, day] = appt.date.split('-');
                const displayDate = `${day}-${month}-${year}`;

                const displayTime = new Date('1970-01-01T' + appt.time).toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
                
                let generateBillButtonHTML = '';
                if (appt.billupdateflag) {
                    generateBillButtonHTML = `
                        <a href="#" onclick="generateBill('${appt.id}'); return false;">Download Bill</a>
                        <a href="#" onclick="viewBill('${appt.id}'); return false;">View Bill</a>
                        <a href="#" onclick="shareBill('${appt.id}'); return false;">Share Bill</a>
                    `;
                }
 
                card.innerHTML = `
                    <div class="card-header">
                        <div>
                            <div class="patient-name">${appt.name || 'N/A'}</div>
                            <div class="contact-info">
                                <a href="tel:${appt.phone}" class="icon-link mobile-only-icon" title="Call Patient"><i class="phone-icon-svg"></i></a>
                                <a href="https://wa.me/${appt.phone}" target="_blank" class="icon-link mobile-only-icon" title="Open WhatsApp Chat"><i class="whatsapp-icon-svg"></i></a>
                                <span>${appt.phone}</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="datetime-info"><strong>Date & Time</strong><span>${displayDate} at ${displayTime}</span></div>
                        <div class="status-details"><strong>Status</strong><span>Conf: ${confirmationStatus} | Review: ${reviewStatus} | Bill: ${billStatus}</span></div>
                    </div>
                    <div class="card-actions">
                        <div class="actions-dropdown">
                            <button class="action-btn actions-main-btn" onclick="toggleActionsDropdown(event, '${appt.id}')">Actions ▾</button>
                            <div id="dropdown-${appt.id}" class="dropdown-content">
                                <a href="#" onclick="sendConfirmation('${appt.id}'); return false;">Confirm Appointment</a>
                                <a href="#" onclick="sendReviewRequest('${appt.id}'); return false;">Send Review Request</a>
                                ${generateBillButtonHTML}
                                <a href="#" onclick="editAppointment('${appt.id}'); return false;">Edit/Add Services</a>
                                <a href="#" onclick="deleteAppointment('${appt.id}'); return false;" style="color: #EF4444;">Delete Appointment</a>
                            </div>
                        </div>
                    </div>
                `;
                appointmentsList.appendChild(card);
            });
        }
    }

    function validatePhone(phone) {
        const sanitizedPhone = phone.replace(/[^0-9]/g, '');

        // Case 1: 10-digit number
        if (sanitizedPhone.length === 10) {
            // Check if it's a valid Indian mobile number (starts with 6, 7, 8, or 9)
            if (/^[6-9]\d{9}$/.test(sanitizedPhone)) {
                return '91' + sanitizedPhone;
            }
        } 
        // Case 2: 12-digit number with country code '91'
        else if (sanitizedPhone.length === 12 && sanitizedPhone.startsWith('91')) {
            const mobilePart = sanitizedPhone.substring(2);
            // Check if the 10-digit part is a valid Indian mobile number
            if (/^[6-9]\d{9}$/.test(mobilePart)) {
                return sanitizedPhone;
            }
        }
        // If neither case matches, it's invalid
        return null;
    }

    // Helper 1: Populates the bill template in the DOM
    function populateBillTemplate({ patientName, billDate, services }) {
        const billDiv = document.getElementById('bill');
        const total = services.reduce((sum, service) => sum + Number(service.cost || 0), 0);

        // --- Populate the professional bill template ---
        // const billNumber = 'INV-' + Date.now().toString().slice(-6);
        // document.getElementById('billNumber').textContent = billNumber;
        document.getElementById('billPatient').textContent = 'Mr./Mrs./Ms. '+ patientName;
        document.getElementById('billDateText').textContent = new Date(billDate + 'T00:00:00').toLocaleDateString('en-GB'); // DD/MM/YYYY

        const billTableBody = document.querySelector('#bill table tbody');
        billTableBody.innerHTML = ''; // Clear previous entries

        services.forEach((service, index) => {
            const row = billTableBody.insertRow();
            const cell1 = row.insertCell(0); // S.No.
            const cell2 = row.insertCell(1); // Description
            const cell3 = row.insertCell(2); // Cost

            cell1.textContent = index + 1;
            cell2.textContent = service.description;
            cell3.textContent = service.cost.toFixed(2);

            // Add styles for a clean look
            cell1.style.padding = '10px 12px';
            cell1.style.borderBottom = '1px solid #eee';
            cell2.style.padding = '10px 12px';
            cell2.style.borderBottom = '1px solid #eee';
            cell3.style.padding = '10px 12px';
            cell3.style.borderBottom = '1px solid #eee';
            cell3.style.textAlign = 'right';
        });

        document.getElementById('billTotal').textContent = '₹' + total.toFixed(2);
    }

    // Helper 2: Takes a screenshot of the #bill div and saves as PDF
    async function saveBillPdf(patientName) {
        const billDiv = document.getElementById('bill');
        try {
            const canvas = await html2canvas(billDiv, {
                scale: 2,
                width: billDiv.scrollWidth, // Use scrollWidth to capture the full width regardless of viewport
                height: billDiv.scrollHeight,
                windowHeight: billDiv.scrollHeight
            });
            
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'portrait', unit: 'px', format: 'a4' });
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);

            const now = new Date();
            const timestamp = now.getFullYear().toString() + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0');
            pdf.save(`bill_${patientName.replace(/ /g, '_')}_${timestamp}.pdf`);
        } catch(error) {
            console.error("Error saving PDF:", error);
            errorDiv.textContent = 'Failed to generate PDF file.';
            errorDiv.style.display = 'block';
            throw error; // Re-throw to be caught by the caller
        }
    }

    // Refactored function for auto-download on page load
    async function populateAndSavePdf(billDetails) {
        populateBillTemplate(billDetails);
        const billDiv = document.getElementById('bill');
        billDiv.style.display = 'flex'; // Temporarily show for rendering
        try {
            await saveBillPdf(billDetails.patientName);
        } finally {
            billDiv.style.display = 'none'; // Hide it again
        }
    }

    // Generates and downloads the bill directly
    window.generateBill = async (id) => {
        showLoader();
        const billDiv = document.getElementById('bill');
        try {
            const row = document.querySelector(`[data-id='${id}']`);
            if (!row) throw new Error("Appointment row not found.");

            const phone = row.dataset.phone;
            if (!phone) throw new Error("Phone number not found for this appointment.");

            const date = row.dataset.date; // Get the date from the record
            if (!date) throw new Error("Date not found for this appointment.");

            // Fetch bill details from the server
            const response = await fetch(`${API_BASE_URL}/api/bill-details/${phone}?date=${date}`);
            if (!response.ok) {
                let errorMsg = `HTTP error! status: ${response.status}`;
                try {
                } catch (e) { /* Ignore if response is not JSON */ }
                throw new Error(errorMsg);
            }
            const billDetails = await response.json();

            // Populate the hidden bill template
            populateBillTemplate(billDetails);

            // Temporarily show the bill for rendering, then save it
            billDiv.style.display = 'flex';
            await saveBillPdf(billDetails.patientName);

        } catch (error) {
            console.error('Error generating bill:', error);
            // Error message is set by saveBillPdf or the fetch block
            if (!errorDiv.textContent) {
                errorDiv.textContent = `Failed to generate bill: ${error.message}`;
                errorDiv.style.display = 'block';
            }
        } finally {
            if (billDiv) billDiv.style.display = 'none'; // Always hide the bill template
            hideLoader();
        }
    };

    // Function to load appointment data into the form for editing
    window.editAppointment = (id) => {
        // Find the appointment in the currently rendered table (or re-fetch if necessary)
        const row = document.querySelector(`[data-id='${id}']`);
        if (!row) {
            console.log(row);
            errorDiv.textContent = 'Appointment not found for editing.';
            errorDiv.style.display = 'block';
            return;
        }

        // Open the form if it's not already open
        if (addFormContainer.style.display !== 'block') {
            addFormContainer.style.display = 'block';
            showAddFormBtn.textContent = '➖ Close Appointment Form';
            showAddFormBtn.classList.add('close-form');
        }

        // Reset form first to clear any previous state
        resetForm();

        // Populate form fields
        editingAppointmentId = id;
        nameInput.value = row.dataset.name;
        phoneInput.value = row.dataset.phone.replace('91', ''); // Remove country code for display
        dateInput.value = row.dataset.date;
        timeInput.value = row.dataset.time;
        
        // Populate services
        const services = JSON.parse(row.dataset.services || '[]');
        services.forEach(service => addService(service.description, service.cost));

        // Change button text to "Update Appointment"
        addBtn.textContent = 'Update Appointment'; 
        addBtn.classList.add('update-mode'); // Add a class for potential styling
        addBtn.style.display = 'block'; // Ensure addBtn is visible when editing

        // As per request: "load value in the text box in the read only mode"
        // Making name and phone read-only, date and time editable for practical editing
        nameInput.readOnly = true;
        phoneInput.readOnly = true;
        dateInput.readOnly = true; // Make date read-only
        timeInput.readOnly = true; // Make time read-only

        errorDiv.style.display = 'none';
    };

    addBtn.addEventListener('click', async () => {
        const name = nameInput.value.trim();
        const phone = phoneInput.value.trim();
        const date = dateInput.value;
        const time = timeInput.value;

        // Collect services and perform validation
        const services = [];
        const serviceItems = document.querySelectorAll('.service-item');
        let hasEmptyService = false;

        // Reset previous validation styles
        document.querySelectorAll('.service-desc').forEach(input => input.style.borderColor = '');

        serviceItems.forEach(item => {
            const serviceDescInput = item.querySelector('.service-desc');
            const serviceDesc = serviceDescInput.value.trim();
            const cost = Number(item.querySelector('.service-cost').value);

            if (!serviceDesc) {
                hasEmptyService = true;
                serviceDescInput.style.borderColor = '#DC2626'; // Highlight empty field
            } else {
                services.push({ description: serviceDesc, cost: cost });
            }
        });

        if (hasEmptyService) {
            errorDiv.textContent = 'A service row was added but the description is empty. Please fill it or remove it.';
            errorDiv.style.display = 'block';
            return;
        }

        // In update mode, at least one service is mandatory.
        if (editingAppointmentId && services.length === 0) {
            errorDiv.textContent = 'At least one service is required when updating an appointment.';
            errorDiv.style.display = 'block';
            return;
        }

        // Validation
        if (!name || !phone || !date || !time) {
            errorDiv.textContent = "Please fill in all required fields (Name, Mobile, Date, Time).";
            errorDiv.style.display = 'block';
            return;
        }
        
        // Only validate phone if not in edit mode (as it might be read-only)
        let validPhone = phone;
        if (!editingAppointmentId) { // If adding new, validate phone
            validPhone = validatePhone(phone);
            if (!validPhone) {
                errorDiv.textContent = "Please enter a valid 10-digit Indian mobile number (starting with 6, 7, 8, or 9).";
                errorDiv.style.display = 'block';
                return;
            }
        } else { // If editing, use the phone from the dataset (which includes country code)
            validPhone = document.querySelector(`[data-id='${editingAppointmentId}']`).dataset.phone;
        }

        errorDiv.style.display = 'none';

        showLoader();
        if (editingAppointmentId) {
            // Update existing appointment
            const updatePayload = {
                name,
                phone: validPhone,
                date,
                time,
                services,
                billupdateflag: true // Flag to indicate an update, especially for billing
            };
            console.log('Update Payload:', updatePayload);

            try {
                const response = await fetch(`${API_BASE_URL}/api/appointments/${editingAppointmentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatePayload)
                });
                if (!response.ok) throw new Error(`Server failed to update appointment: ${response.status} - ${response.statusText}`);
                resetForm();
                addFormContainer.style.display = 'none';
                showAddFormBtn.textContent = '➕ Add New Appointment';
                showAddFormBtn.classList.remove('close-form');
                addBtn.style.display = 'none'; // Hide addBtn after successful update
                await loadAppointmentsByDate(filterDateInput.value);
            } catch (error) {
                console.error('Error updating appointment:', error);
                errorDiv.textContent = `Failed to update appointment on the server: ${error.message}`;
                errorDiv.style.display = 'block';
            } finally {
                hideLoader();
            }
        } else {
            // Add new appointment
            const newAppointmentPayload = { 
                name,
                phone: validPhone, // Store the full number with country code
                date, 
                time,
                services, // Include services
                confirmationSent: false,
                reviewSent: false,
                billupdateflag: false // Set to false on initial creation
            };
            try {
                const response = await fetch(`${API_BASE_URL}/api/appointments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newAppointmentPayload)
                });
                if (!response.ok) throw new Error(`Server failed to add appointment: ${response.status} - ${response.statusText}`);

                resetForm();
                addFormContainer.style.display = 'none';
                showAddFormBtn.textContent = '➕ Add New Appointment';
                showAddFormBtn.classList.remove('close-form');
                addBtn.style.display = 'none'; // Hide addBtn after successful add
                await loadAppointmentsByDate(filterDateInput.value);
            } catch (error) {
                console.error('Error adding appointment:', error);
                errorDiv.textContent = `Failed to add appointment to the server: ${error.message}`;
                errorDiv.style.display = 'block';
            } finally {
                hideLoader();
            }
        }
    });

    window.deleteAppointment = async (id) => {
        if (confirm("Are you sure you want to delete this appointment?")) {
            showLoader();
            try {
                const response = await fetch(`${API_BASE_URL}/api/appointments/${id}`, { method: 'DELETE' }); // Standard DELETE for a specific resource
                if (!response.ok) throw new Error('Server failed to delete appointment.');
                await loadAppointmentsByDate(filterDateInput.value);
            } catch (error) {
                console.error('Error deleting appointment:', error);
                errorDiv.textContent = 'Failed to delete appointment on the server.';
                errorDiv.style.display = 'block';
            } finally {
                hideLoader();
            }
        }
    };

    window.sendConfirmation = async (id) => {
        const row = document.querySelector(`[data-id='${id}']`);
        if (!row) return;

        // Get data from the row's dataset for reliability
        const name = row.dataset.name;
        const phone = row.dataset.phone;
        const date = row.dataset.date;
        const time = row.dataset.time;

        // Format date for display
        const dateObj = new Date(date + 'T00:00:00');
        const dateOptions = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
        const displayDate = dateObj.toLocaleDateString('en-US', dateOptions);

        // Format time for display
        const [hours, minutes] = time.split(':');
        const timeObj = new Date();
        timeObj.setHours(hours, minutes, 0, 0);
        const displayTime = timeObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });

        const location = "Dr. Mani's Ortho Speciality & General Clinic, 68, Radha Nagar Main Road, Opposite J2 Mahal, Chromepet, Chennai";
        const mapLink = "https://www.google.com/maps/dir/?api=1&destination=Dr+Mani's+Ortho+Speciality+%26+General+Clinic,Chromepet,Chennai";
        const message = `Hello ${name},
Thank you for speaking with us today.
As confirmed, your appointment is scheduled:

📅 Date: ${displayDate}
⏰ Time: ${displayTime}
🏥 Location: ${location}
📍 Google Map: ${mapLink}

Please let us know if you need any changes.
We look forward to seeing you.`;

        const encodedMessage = encodeURIComponent(message);
        const url = `https://wa.me/${phone}?text=${encodedMessage}`;
        window.open(url, "_blank");

        showLoader();
        // Update status on the server
        try {
            const response = await fetch(`${API_BASE_URL}/api/appointments/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ confirmationSent: true })
            });
            if (!response.ok) throw new Error(`Server failed to update status: ${response.status} - ${response.statusText}`); 
            await loadAppointmentsByDate(filterDateInput.value);
        } catch (error) {
            console.error('Error updating status:', error);
            // Optionally show an error to the user
        } finally {
            hideLoader();
        }
    };

    window.sendReviewRequest = async (id) => {
        const row = document.querySelector(`[data-id='${id}']`);
        if (!row) return;

        // Get data from the row's dataset for reliability
        const name = row.dataset.name;
        const phone = row.dataset.phone;
        if (!phone) return;

        const message =
`Hello ${name},
Thank you for visiting *Dr. Mani's Ortho Speciality & General Clinic*.

Your review means a lot to us — it helps others find the right care and encourages our team.
If you were happy with our service, please give us a *5-star rating* ⭐⭐⭐⭐⭐.
You can share your feedback here: https://g.page/r/CfKLCQ4kwt5UEBM/review`;

        const encodedMessage = encodeURIComponent(message);
        const waLink = `https://wa.me/${phone}?text=${encodedMessage}`;
        window.open(waLink, '_blank');

        showLoader();
        // Update status on the server
        try {
            const response = await fetch(`${API_BASE_URL}/api/appointments/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reviewSent: true })
            });
            if (!response.ok) throw new Error(`Server failed to update status: ${response.status} - ${response.statusText}`); 
            await loadAppointmentsByDate(filterDateInput.value);
        } catch (error) {
            console.error('Error updating status:', error);
            // Optionally show an error to the user
        } finally {
            hideLoader();
        }
    };

    window.shareBill = async (id) => {
        const row = document.querySelector(`[data-id='${id}']`);
        if (!row) return;

        const name = row.dataset.name;
        const phone = row.dataset.phone;
        const billUpdateFlag = row.dataset.billupdateflag === 'true';

        if (!phone || !billUpdateFlag) return;

        const cleanUrl = window.location.origin + window.location.pathname;
        const billDownloadUrl = `${cleanUrl}?bill_phone=${phone}&date=${row.dataset.date}`;

        const message =
`Hello ${name},
Thank you for visiting *Dr. Mani's Ortho Speciality & General Clinic*.

You can download your bill using the link below:
${billDownloadUrl}

We wish you a speedy recovery!`;

        const encodedMessage = encodeURIComponent(message);
        const waLink = `https://wa.me/${phone}?text=${encodedMessage}`;
        window.open(waLink, '_blank');
    };

    window.viewBill = (id) => {
        const row = document.querySelector(`[data-id='${id}']`);
        if (!row) return;

        const phone = row.dataset.phone;
        const billUpdateFlag = row.dataset.billupdateflag === 'true';

        if (!phone || !billUpdateFlag) return;

        const cleanUrl = window.location.origin + window.location.pathname;
        const billViewUrl = `${cleanUrl}?view_bill_phone=${phone}&date=${row.dataset.date}`;
        window.open(billViewUrl, '_blank');
    };
    // Function to toggle the actions dropdown
    window.toggleActionsDropdown = (event, id) => {
        event.stopPropagation(); // Prevent the global click listener from closing it immediately
        const dropdown = document.getElementById(`dropdown-${id}`);
        const isVisible = dropdown.style.display === 'block';

        // Close all other open dropdowns first
        document.querySelectorAll('.dropdown-content').forEach(d => {
            if (d.id !== `dropdown-${id}`) {
                d.style.display = 'none';
            }
        });

        // Toggle the clicked dropdown
        dropdown.style.display = isVisible ? 'none' : 'block';
    };
  </script>
</body>
</html>
