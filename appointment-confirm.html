<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Appointment Manager</title>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      padding: 20px;
      margin: 0;
      background: #F8FAFC;
      color: #334155;
      display: flex;
      justify-content: center;
      align-items: flex-start; /* Align to top to see table */
      min-height: 100vh;
      box-sizing: border-box;
    }

    .container {
      background: #fff;
      border: 1px solid #e0e0e0;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 900px; /* Wider container for table */
      box-sizing: border-box;
    }

    .back-link {
      display: inline-block;
      margin-bottom: 15px;
      color: #0D9488;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    h2 {
      margin-bottom: 20px;
      color: #0D9488;
      text-align: center;
      font-size: 1.5rem;
      margin-top: 0;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      margin-top: 12px;
    }

    input[type="text"],
    input[type="date"],
    input[type="tel"],
    input[type="time"],
    textarea {
      width: 100%;
      padding: 12px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
      box-sizing: border-box;
      color: #334155;
      background-color: #fff;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    input[type="tel"]:focus,
    input[type="time"]:focus,
    textarea:focus {
      outline: none;
      border-color: #0D9488;
      box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.2);
    }

    textarea {
      resize: none;
      height: 80px;
    }

    button {
      width: 100%;
      padding: 12px 0;
      background-color: #0D9488;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      margin-top: 15px;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }

    button:hover {
      background-color: #0F766E;
      transform: translateY(-2px);
    }

    .error {
      color: #991B1B;
      background-color: #FEE2E2;
      border: 1px solid #FCA5A5;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
      font-size: 0.9rem;
      display: none;
    }

    /* Table Styles */
    .table-container {
      margin-top: 30px;
      width: 100%;
    }

    .appointments-table {
      width: 100%;
      border-collapse: separate; /* Use separate to allow spacing */
      border-spacing: 0 1rem; /* This creates vertical space between rows (cards) */
      font-size: 0.9rem;
    }
    .appointments-table th, .appointments-table td {
      border: none;
      padding: 0;
      text-align: left;
      vertical-align: middle;
    }
    .appointments-table th {
      padding: 0 10px 10px;
      border-bottom: 2px solid #e0e0e0;
      background-color: transparent;
      font-weight: 600;
      color: #0F766E;
    }
    .appointments-table .action-btn {
      font-size: 0.8rem;
      padding: 6px 10px;
      margin: 0;
      width: auto;
      min-width: 80px;
      display: inline-block;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .appointments-table .action-btn:last-child {
        margin-right: 0;
    }
    
    .confirm-btn {
        background-color: #0D9488;
    }
    .confirm-btn:hover {
        background-color: #0F766E;
    }

    .review-btn {
        background-color: #14B8A6;
    }
    .review-btn:hover {
        background-color: #0D9488;
    }

    .delete-btn {
      background-color: #DC2626;
    }
    .delete-btn:hover {
      background-color: #B91C1C;
    }

    #clearAllBtn {
        background-color: #b91c1c;
        margin-top: 20px;
    }
    #clearAllBtn:hover {
        background-color: #991b1b;
    }

    #showAddFormBtn {
        background-color: #14B8A6;
    }
    #showAddFormBtn:hover {
        background-color: #0D9488;
    }

    #showAddFormBtn.close-form {
        background-color: #DC2626; /* Red color */
    }
    #showAddFormBtn.close-form:hover {
        background-color: #B91C1C; /* Darker red on hover */
    }

    .form-container-collapsible {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        background-color: #F8FAFC;
        display: none; /* Hidden by default */
    }

    /* Status cell styles */
    .status-pending {
        color: #D97706; /* Amber 600 */
        font-style: italic;
    }
    .status-sent {
        font-weight: bold;
    }
    .status-confirmed {
        color: #0D9488; /* Teal 600 */
    }
    .status-review-sent {
        color: #16A34A; /* Green 600 */
    }

    /* New Card Layout Styles */
    .appointment-card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      border: 1px solid #e2e8f0;
      overflow: hidden; /* Ensures border-radius is respected by children */
    }
    .card-data {
        padding: 15px 20px;
    }
    .card-data .card-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #f1f5f9;
        font-size: 0.95rem;
    }
    .card-data .card-item:last-child {
        border-bottom: none;
    }
    .card-item strong {
        color: #0F766E;
        margin-right: 10px;
        white-space: nowrap;
        font-weight: 600;
    }
    .card-item span {
        color: #475569;
        text-align: right;
    }
    .card-actions {
        background-color: #F8FAFC;
        padding: 15px 20px;
        border-top: 1px solid #e2e8f0;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    .card-actions .action-btn {
        flex-grow: 1;
    }
    .icon-link {
        text-decoration: none;
        margin-right: 10px;
        font-size: 1.2rem; /* Slightly larger for better touch target */
        display: inline-flex;
        align-items: center;
    }
    .whatsapp-icon-svg {
        display: inline-block;
        width: 1.1rem;
        height: 1.1rem;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2325D366' viewBox='0 0 16 16'%3e%3cpath d='M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.068-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-size: contain;
    }

    /* Hide icons on desktop (screens wider than 768px) */
    @media (min-width: 768px) {
      .mobile-only-icon {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="admin.html" class="back-link">← Back to Admin Panel</a>
    <h2>Appointment Manager</h2>
    <div id="error" class="error"></div>

    <div id="add-form-container" class="form-container-collapsible">
        <label for="name">Patient Name:</label>
        <input type="text" id="name" placeholder="Enter patient's name">

        <label for="phone">Mobile Number:</label>
        <input type="tel" id="phone" placeholder="e.g. 9444261111">

        <label for="date">Date:</label>
        <input type="date" id="date">

        <label for="time">Time:</label>
        <input type="time" id="time">

        <button id="addBtn">Add to List</button>
    </div>
    
    <button id="showAddFormBtn">➕ Add New Appointment</button>

    <div class="table-container">
        <table class="appointments-table">
            <thead>
                <tr>
                    <th>Appointment Details</th>
                </tr>
            </thead>
            <tbody id="appointmentsTbody">
                <!-- Rows will be added here by JavaScript -->
            </tbody>
        </table>
    </div>
    <button id="clearAllBtn">Clear All Appointments</button>

  </div>

  <script>
    // Element selectors
    const nameInput = document.getElementById('name');
    const phoneInput = document.getElementById('phone');
    const dateInput = document.getElementById('date');
    const timeInput = document.getElementById('time');
    const addBtn = document.getElementById('addBtn');
    const showAddFormBtn = document.getElementById('showAddFormBtn');
    const addFormContainer = document.getElementById('add-form-container');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const appointmentsTbody = document.getElementById('appointmentsTbody');
    const errorDiv = document.getElementById("error");
    const API_BASE_URL = 'https://dr-appointment-t10x.onrender.com';
    //const API_BASE_URL = 'http://localhost:3000';

    // Set today's date in the date input field on page load
    window.onload = function() {
      const today = new Date();

      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
      const dd = String(today.getDate()).padStart(2, '0');
      dateInput.value = `${yyyy}-${mm}-${dd}`;
      loadAndRenderAppointments();
      //loadHello();
    };

    showAddFormBtn.addEventListener('click', () => {
        const isVisible = addFormContainer.style.display === 'block';
        if (isVisible) {
            // Form is visible, so we are closing it
            addFormContainer.style.display = 'none';
            showAddFormBtn.textContent = '➕ Add New Appointment';
            showAddFormBtn.classList.remove('close-form');
        } else {
            // Form is hidden, so we are opening it
            addFormContainer.style.display = 'block';
            showAddFormBtn.textContent = '➖ Close Appointment Form';
            showAddFormBtn.classList.add('close-form');
        }
    });
    
    async function loadAndRenderAppointments() {
        try {
            const response = await fetch(`${API_BASE_URL}/api/appointments`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const appointments = await response.json();
            renderTable(appointments);
        } catch (error) {
            console.error('Failed to load appointments:', error);
            errorDiv.textContent = 'Could not load appointments from the server. Make sure the server is running.';
            errorDiv.style.display = 'block';
        }
    }
     

    function renderTable(appointments) {
        appointmentsTbody.innerHTML = ''; // Clear existing rows

        if (appointments.length === 0) {
            const row = appointmentsTbody.insertRow();
            const cell = row.insertCell(0);
            cell.colSpan = 1;
            cell.textContent = 'No appointments scheduled.';
            cell.style.textAlign = 'center';
        } else {
            appointments.forEach(appt => {
                const row = appointmentsTbody.insertRow();
                row.dataset.id = appt.id;
 
                const confirmationStatus = appt.confirmationSent 
                    ? `<span class="status-sent status-confirmed">Sent</span>`
                    : `<span class="status-pending">Pending</span>`;

                const reviewStatus = appt.reviewSent
                    ? `<span class="status-sent status-review-sent">Sent</span>`
                    : `<span class="status-pending">Pending</span>`;

                const cell = row.insertCell(0);
                cell.innerHTML = `
                    <div class="appointment-card">
                        <div class="card-data">
                            <div class="card-item"><strong>Name:</strong> <span>${appt.name || 'N/A'}</span></div>
                            <div class="card-item">
                                <strong>Mobile:</strong> 
                                <span style="display: flex; align-items: center;">
                                    <a href="tel:${appt.phone}" class="icon-link mobile-only-icon" title="Call Patient">📞</a>
                                    <a href="https://wa.me/${appt.phone}" target="_blank" class="icon-link mobile-only-icon" title="Open WhatsApp Chat"><i class="whatsapp-icon-svg"></i></a>
                                    ${appt.phone}
                                </span>
                            </div>
                            <div class="card-item"><strong>Date:</strong> <span>${appt.date}</span></div>
                            <div class="card-item"><strong>Time:</strong> <span>${appt.time}</span></div>
                            <div class="card-item"><strong>Confirmation:</strong> ${confirmationStatus}</div>
                            <div class="card-item"><strong>Review:</strong> ${reviewStatus}</div>
                        </div>
                        <div class="card-actions">
                            <button class="action-btn confirm-btn" onclick="sendConfirmation('${appt.id}')">Confirmation Msg</button>
                            <button class="action-btn review-btn" onclick="sendReviewRequest('${appt.id}')">Review Message</button>
                            <button class="action-btn delete-btn" onclick="deleteAppointment('${appt.id}')">Delete</button>
                        </div>
                    </div>
                `;
            });
        }
    }

    function validatePhone(phone) {
        const sanitizedPhone = phone.replace(/[^0-9]/g, '');

        // Case 1: 10-digit number
        if (sanitizedPhone.length === 10) {
            // Check if it's a valid Indian mobile number (starts with 6, 7, 8, or 9)
            if (/^[6-9]\d{9}$/.test(sanitizedPhone)) {
                return '91' + sanitizedPhone;
            }
        } 
        // Case 2: 12-digit number with country code '91'
        else if (sanitizedPhone.length === 12 && sanitizedPhone.startsWith('91')) {
            const mobilePart = sanitizedPhone.substring(2);
            // Check if the 10-digit part is a valid Indian mobile number
            if (/^[6-9]\d{9}$/.test(mobilePart)) {
                return sanitizedPhone;
            }
        }
        // If neither case matches, it's invalid
        return null;
    }

    addBtn.addEventListener('click', async () => {
        const name = nameInput.value.trim();
        const phone = phoneInput.value.trim();
        const date = dateInput.value;
        const time = timeInput.value;

        if (!name || !phone || !date || !time) {
            errorDiv.textContent = "Please fill in all required fields to add an appointment.";
            errorDiv.style.display = 'block';
            return;
        }
        
        const validPhone = validatePhone(phone);
        if (!validPhone) {
            errorDiv.textContent = "Please enter a valid 10-digit Indian mobile number (starting with 6, 7, 8, or 9).";
            errorDiv.style.display = 'block';
            return;
        }

        errorDiv.style.display = 'none';

        const newAppointment = { 
            name,
            phone: validPhone, // Store the full number with country code
            date, 
            time,
            confirmationSent: false,
            reviewSent: false
        };

        try {
            const response = await fetch(`${API_BASE_URL}/api/appointments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newAppointment)
            });
            if (!response.ok) throw new Error('Server failed to add appointment.');

            // Clear inputs and re-render
            nameInput.value = '';
            phoneInput.value = '';
            timeInput.value = '';
            addFormContainer.style.display = 'none';
            showAddFormBtn.textContent = '➕ Add New Appointment';
            showAddFormBtn.classList.remove('close-form');
            loadAndRenderAppointments();
        } catch (error) {
            console.error('Error adding appointment:', error);
            errorDiv.textContent = 'Failed to add appointment to the server.';
            errorDiv.style.display = 'block';
        }
    });

    clearAllBtn.addEventListener('click', async () => {
        if (confirm("Are you sure you want to clear the entire list of appointments? This action cannot be undone.")) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/appointments`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Server failed to clear appointments.');
                loadAndRenderAppointments();
            } catch (error) {
                console.error('Error clearing appointments:', error);
                errorDiv.textContent = 'Failed to clear all appointments on the server.';
                errorDiv.style.display = 'block';
            }
        }
    });

    window.deleteAppointment = async (id) => {
        if (confirm("Are you sure you want to delete this appointment?")) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/appointments/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Server failed to delete appointment.');
                loadAndRenderAppointments();
            } catch (error) {
                console.error('Error deleting appointment:', error);
                errorDiv.textContent = 'Failed to delete appointment on the server.';
                errorDiv.style.display = 'block';
            }
        }
    };

    window.sendConfirmation = async (id) => {
        const row = document.querySelector(`[data-id='${id}']`);
        if (!row) return;
        
        const name = row.querySelector('.card-item:nth-child(1) span').textContent;
        const phone = row.querySelector('.card-item:nth-child(2) span').textContent;
        const date = row.querySelector('.card-item:nth-child(3) span').textContent;
        const time = row.querySelector('.card-item:nth-child(4) span').textContent;

        // Format date for display
        const dateObj = new Date(date + 'T00:00:00');
        const dateOptions = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
        const displayDate = dateObj.toLocaleDateString('en-US', dateOptions);

        // Format time for display
        const [hours, minutes] = time.split(':');
        const timeObj = new Date();
        timeObj.setHours(hours, minutes, 0, 0);
        const displayTime = timeObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });

        const location = "Dr. Mani's Ortho Speciality & General Clinic, 68, Radha Nagar Main Road, Opposite J2 Mahal, Chromepet, Chennai";
        const mapLink = "https://www.google.com/maps/dir/?api=1&destination=Dr+Mani's+Ortho+Speciality+%26+General+Clinic,Chromepet,Chennai";
        const message = `Hello ${name},
Thank you for speaking with us today.
As confirmed, your appointment is scheduled:

📅 Date: ${displayDate}
⏰ Time: ${displayTime}
🏥 Location: ${location}
📍 Google Map: ${mapLink}

Please let us know if you need any changes.
We look forward to seeing you.`;

        const encodedMessage = encodeURIComponent(message);
        const url = `https://wa.me/${phone}?text=${encodedMessage}`;
        window.open(url, "_blank");

        // Update status on the server
        try {
            const response = await fetch(`${API_BASE_URL}/api/appointments/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ confirmationSent: true })
            });
            if (!response.ok) throw new Error('Server failed to update status.');
            loadAndRenderAppointments();
        } catch (error) {
            console.error('Error updating status:', error);
        }
    };

    window.sendReviewRequest = async (id) => {
        const row = document.querySelector(`[data-id='${id}']`);
        if (!row) return;

        const name = row.querySelector('.card-item:nth-child(1) span').textContent;
        const phone = row.querySelector('.card-item:nth-child(2) span').textContent;
        if (!phone) return;

        const message =
`Hello ${name},
Thank you for visiting *Dr. Mani's Ortho Speciality & General Clinic*.
Your review means a lot to us — it helps others find the right care and encourages our team.
If you were happy with our service, please give us a *5-star rating* ⭐⭐⭐⭐⭐.
You can share your feedback here: https://g.page/r/CfKLCQ4kwt5UEBM/review
Your rating would help us serve you even better!`;

        const encodedMessage = encodeURIComponent(message);
        const waLink = `https://wa.me/${phone}?text=${encodedMessage}`;
        window.open(waLink, '_blank');

        // Update status on the server
        try {
            const response = await fetch(`${API_BASE_URL}/api/appointments/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reviewSent: true })
            });
            if (!response.ok) throw new Error('Server failed to update status.');
            loadAndRenderAppointments();
        } catch (error) {
            console.error('Error updating status:', error);
        }
    };
  </script>
</body>
</html>